---
import '../styles/global.css';
// Component Imports
// import Button from '../components/Button.astro';
// import ReactCounter from '../components/ReactCounter';
import BookmarkCard from '../components/BookmarkCard.astro';
import { getSessionCookie} from "../lib/oauth.ts";
import { db } from '../lib/db.ts';
export const prerender = false;
const req = Astro.request;
const headers = req.headers;

// verify session cookie
const sessionId = getSessionCookie(headers);
let isAuthenticated = false;

if (sessionId) {
  const token = await db.getToken(sessionId);
  if (token && token.expiresAt && Number(token.expiresAt) > Date.now()) {
    isAuthenticated = true;
  }
}

// Full Astro Component Syntax:
// https://docs.astro.build/basics/astro-components/
const url = new URL(Astro.request.url);
const q = url.searchParams.get('q') || '';
const tag = url.searchParams.get('tag') || '';
const domain = url.searchParams.get('domain') || '';
const sort = url.searchParams.get('sort') || 'added_at';
const order = url.searchParams.get('order') || 'desc';
const page = Number(url.searchParams.get('page') || 1);
const pageSize = Number(url.searchParams.get('pageSize') || 24);

let initial = { items: [], totalCount: 0, page, pageSize };
let allTags: string[] = [];
let allDomains: string[] = [];

// Server-side initial data
if (isAuthenticated) {
    const origin = new URL(Astro.request.url).origin;
    const apiUrl = new URL('/api/gmail/links', origin);

    apiUrl.searchParams.set('page', String(page));
    apiUrl.searchParams.set('pageSize', String(pageSize));
    if (q) apiUrl.searchParams.set('q', q);
    if (tag) apiUrl.searchParams.set('tag', tag);
    if (domain) apiUrl.searchParams.set('domain', domain);
    apiUrl.searchParams.set('sort', sort);
    apiUrl.searchParams.set('order', order);

    const response = await fetch(apiUrl, {
        headers: {
            cookie: Astro.request.headers.get('cookie') ?? '',
        },
    });
    if (response.ok) {
        initial = await response.json();
        allTags = Array.from(new Set(initial.items.flatMap((i:any)=>i.tags||[]))).sort();
        allDomains = Array.from(new Set(initial.items.map((i:any)=>i.domain))).sort();
    }
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="generator" content={Astro.generator} />
		<title>Astro + TailwindCSS</title>
	</head>

    <body class="bg-white text-gray-900">
    <main class="max-w-7xl mx-auto p-4">
        <header class="flex flex-wrap items-center justify-between gap-3 mb-6">
            <h1 class="text-2xl font-bold">DraftMarks</h1>
            <a href="/settings" class="text-sm underline">Settings</a>
        </header>

        { !isAuthenticated && (
                <section class="rounded-2xl border p-6 text-center">
                    <h2 class="text-lg font-semibold mb-2">Connect your Gmail account</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        Sign in with Google to fetch your Gmail drafts and turn them into a visual bookmark library.
                    </p>
                    <a
                            href="/api/oauth/google"
                            class="inline-flex items-center justify-center px-4 py-2 rounded-xl border font-medium"
                    >
                        Connect with Google
                    </a>
                </section>
        )}

        { isAuthenticated && (
                <>
                    <!-- Search & controls -->
                    <section class="rounded-2xl border p-3 mb-4">
                        <form id="controls" class="flex flex-wrap items-center gap-2">
                            <input name="q" value={q} placeholder="Search title / url / tag…" class="w-full sm:w-80 px-3 py-2 rounded-xl border outline-none focus:ring" />
                            <select name="tag" class="px-3 py-2 rounded-xl border">
                                <option value="">All tags</option>
                                {allTags.map(t => <option selected={tag===t} value={t}>#{t}</option>)}
                            </select>
                            <input name="domain" value={domain} placeholder="Domain (e.g. github.com)" class="px-3 py-2 rounded-xl border outline-none focus:ring" />
                            <select name="sort" class="px-3 py-2 rounded-xl border">
                                <option value="added_at" selected={sort==='added_at'}>Newest</option>
                                <option value="last_seen_at" selected={sort==='last_seen_at'}>Last seen</option>
                                <option value="domain" selected={sort==='domain'}>Domain</option>
                                <option value="title" selected={sort==='title'}>Title</option>
                            </select>
                            <select name="order" class="px-3 py-2 rounded-xl border">
                                <option value="desc" selected={order==='desc'}>Desc</option>
                                <option value="asc" selected={order==='asc'}>Asc</option>
                            </select>
                            <button type="button" id="resync" class="ml-auto px-3 py-2 rounded-xl border">Resync</button>
                        </form>
                    </section>

                    <!-- Stats -->
                    <section id="stats" class="mb-4 text-sm text-gray-600">
                        <span id="stat-count">{initial.totalCount}</span> links · Page <span id="stat-page">{initial.page}</span>
                    </section>

                    <!-- Grid -->
                    <section id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {initial.items.map((item:any) => (
                                <BookmarkCard url={item.url}
                                title={item.title} domain={item.domain} tags={item.tags} description={item.description} faviconUrl={item.faviconUrl} ogImageUrl={item.ogImageUrl}
                                />
                        ))}
                    </section>

                    <!-- Pagination -->
                    <nav class="flex items-center justify-center gap-2 mt-6">
                        <button id="prev" class="px-3 py-2 rounded-xl border" disabled={page<=1}>Prev</button>
                        <button id="next" class="px-3 py-2 rounded-xl border" disabled={initial.items.length < pageSize}>Next</button>
                    </nav>
                </>
        )}
    </main>

    { isAuthenticated && (
        <>
            <script type="application/json" id="initial-data">{JSON.stringify(initial)}</script>
            <script type="module">
                const initialDataEl = document.getElementById('initial-data');
                const initialData = initialDataEl?.textContent ? JSON.parse(initialDataEl.textContent) : { items: [], totalCount: 0, page: 1, pageSize: 24 };

                const controls = document.getElementById('controls');
                const grid = document.getElementById('grid');
                const statCount = document.getElementById('stat-count');
                const statPage = document.getElementById('stat-page');
                const prevBtn = document.getElementById('prev');
                const nextBtn = document.getElementById('next');
                const resyncBtn = document.getElementById('resync');

                if (!controls || !grid || !statCount || !statPage || !prevBtn || !nextBtn || !resyncBtn) {
                    console.error('Missing UI elements for search/pagination/resync controls');
                    return;
                }

                const formElements = controls.elements;
                const getFieldValue = (name) => {
                    const el = formElements.namedItem(name);
                    if (el instanceof HTMLInputElement || el instanceof HTMLSelectElement) {
                        return el.value;
                    }
                    return '';
                };

                const state = {
                    page: initialData.page ?? 1,
                    pageSize: initialData.pageSize ?? 24,
                    q: getFieldValue('q'),
                    tag: getFieldValue('tag'),
                    domain: getFieldValue('domain'),
                    sort: getFieldValue('sort') || 'added_at',
                    order: getFieldValue('order') || 'desc',
                };

                const buildCard = (item) => {
                    const favicon = item.faviconUrl || `https://www.google.com/s2/favicons?domain=${item.domain}`;
                    const tags = Array.isArray(item.tags) ? item.tags : [];

                    return `
                        <article class="bg-white rounded-2xl shadow p-3 flex flex-col hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <img src="${favicon}" alt="favicon" class="w-5 h-5 mr-2" />
                                <span class="text-sm text-gray-500">${item.domain || ''}</span>
                            </div>
                            ${item.ogImageUrl ? `<img src="${item.ogImageUrl}" alt="${item.title || ''}" class="rounded-lg mb-2 object-cover h-32 w-full" />` : ''}
                            <h2 class="font-semibold text-lg mb-1 truncate">${item.title || item.url}</h2>
                            ${item.description ? `<p class="text-sm text-gray-600 mb-2 line-clamp-2">${item.description}</p>` : ''}
                            <div class="flex flex-wrap gap-1 mb-2">
                                ${tags.map((t) => `<span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">#${t}</span>`).join('')}
                            </div>
                            <a href="${item.url}" target="_blank" class="text-blue-600 text-sm mt-auto">Ouvrir</a>
                        </article>
                    `;
                };

                const renderData = (data) => {
                    const { items, totalCount, page, pageSize } = data;
                    grid.innerHTML = items.length
                        ? items.map(buildCard).join('')
                        : '<p class="col-span-full text-center text-gray-500">No links found.</p>';

                    statCount.textContent = String(totalCount ?? items.length);
                    statPage.textContent = String(page);

                    prevBtn.toggleAttribute('disabled', page <= 1);
                    const maxShown = page * pageSize;
                    const reachedEnd = totalCount ? maxShown >= totalCount : items.length < pageSize;
                    nextBtn.toggleAttribute('disabled', reachedEnd);
                };

                renderData(initialData);

                const updateUrl = () => {
                    const params = new URLSearchParams();
                    if (state.q) params.set('q', state.q);
                    if (state.tag) params.set('tag', state.tag);
                    if (state.domain) params.set('domain', state.domain);
                    if (state.sort) params.set('sort', state.sort);
                    if (state.order) params.set('order', state.order);
                    if (state.page > 1) params.set('page', String(state.page));
                    params.set('pageSize', String(state.pageSize));
                    const query = params.toString();
                    const nextUrl = query ? `?${query}` : window.location.pathname;
                    window.history.replaceState({}, '', nextUrl);
                };

                const toggleLoading = (loading) => {
                    controls.querySelectorAll('input, select, button').forEach((el) => {
                        if (el instanceof HTMLInputElement || el instanceof HTMLSelectElement || el instanceof HTMLButtonElement) {
                            el.toggleAttribute('disabled', loading);
                        }
                    });
                    resyncBtn.textContent = loading ? 'Syncing…' : 'Resync';
                };

                const fetchData = async () => {
                    const url = new URL('/api/gmail/links', window.location.origin);
                    url.searchParams.set('page', String(state.page));
                    url.searchParams.set('pageSize', String(state.pageSize));
                    if (state.q) url.searchParams.set('q', state.q);
                    if (state.tag) url.searchParams.set('tag', state.tag);
                    if (state.domain) url.searchParams.set('domain', state.domain);
                    if (state.sort) url.searchParams.set('sort', state.sort);
                    if (state.order) url.searchParams.set('order', state.order);

                    toggleLoading(true);
                    try {
                        const response = await fetch(url.toString(), { credentials: 'same-origin' });
                        if (!response.ok) {
                            throw new Error('Failed to fetch links');
                        }
                        const data = await response.json();
                        renderData(data);
                        updateUrl();
                    } catch (err) {
                        console.error(err);
                        grid.innerHTML = '<p class="col-span-full text-center text-red-600">An error occurred while loading links.</p>';
                    } finally {
                        toggleLoading(false);
                    }
                };

                controls.addEventListener('submit', (event) => {
                    event.preventDefault();
                    state.page = 1;
                    state.q = getFieldValue('q').trim();
                    state.tag = getFieldValue('tag');
                    state.domain = getFieldValue('domain').trim();
                    state.sort = getFieldValue('sort') || 'added_at';
                    state.order = getFieldValue('order') || 'desc';
                    fetchData();
                });

                ['change', 'input'].forEach((evt) => {
                    controls.addEventListener(evt, (event) => {
                        if (!(event.target instanceof HTMLInputElement || event.target instanceof HTMLSelectElement)) return;
                        if (['q', 'domain'].includes(event.target.name) && evt === 'input') {
                            return;
                        }
                        controls.dispatchEvent(new Event('submit'));
                    });
                });

                prevBtn.addEventListener('click', () => {
                    if (state.page <= 1) return;
                    state.page -= 1;
                    fetchData();
                });

                nextBtn.addEventListener('click', () => {
                    state.page += 1;
                    fetchData();
                });

                resyncBtn.addEventListener('click', () => {
                    state.page = 1;
                    fetchData();
                });
            </script>
        </>
    )}
    </body>
</html>
