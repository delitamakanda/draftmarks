---
import '../styles/global.css';
import Button from "../components/Button.astro";
import { getSessionCookie} from "../lib/oauth.ts";
import { db } from '../lib/db.ts';
export const prerender = false;
const req = Astro.request;
const headers = req.headers;

// verify session cookie
const sessionId = getSessionCookie(headers);
let isAuthenticated = false;

if (sessionId) {
    const token = await db.getToken(sessionId);
    if (token && token.expiresAt && Number(token.expiresAt) > Date.now()) {
        isAuthenticated = true;
    }
}

interface Settings {
    id: string;
    title: string;
    description: string;
    keywords: string[];
    href: string;
}

const settings: Settings[] = [
    {
        id: "legal-page",
        title: "Mentions légales",
        description: "Mentions légales de notre site",
        keywords: ["mentions légales", "politique de confidentialité", "cookies"],
        href: "/mentions-legales"
    },
    {
        id: "privacy-policy-page",
        title: "Politique de confidentialité",
        description: "Politique de confidentialité de notre site",
        keywords: ["politique de confidentialité", "cookies", "protection des données personnelles"],
        href: "/politique-de-confidentialite"
    },
    {
        id: "terms-of-service-page",
        title: "Conditions d'utilisation",
        description: "Conditions d'utilisation de notre site",
        keywords: ["conditions d'utilisation", "cookies", "droit d'accès et de rectification"],
        href: "/conditions-d-utilisation"
    },
    {
        id: "contact-page",
        title: "Contact",
        description: "Contactez-nous pour toute question ou demande",
        keywords: ["contact", "formulaire de contact", "répondre à un message"],
        href: "/contact"
    },
    {
        id: "accounts-page",
        title: "Paramètres",
        description: "Paramètres de votre compte",
        keywords: ["compte", "réinitialiser le mot de passe", "changer d'adresse email"],
        href: "/parametres-de-compte"
    }
];
---
<html lang="fr">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>Astro + TailwindCSS</title>
    </head>
    <body class="bg-white text-gray-900">
    <main class="max-w-7xl mx-auto p-4">
        <header class="flex flex-wrap items-center justify-between gap-3 mb-6">
            <h1 class="text-2xl font-bold">DraftMarks</h1>
            <a href="/" class="text-sm underline">Home</a>
        </header>
        {!isAuthenticated? (
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                    <p class="text-blue-900 mb-4">
                        You must be logged in to access your account settings.
                    </p>
                    <a href="/api/oauth/google" class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Sign in with Google
                    </a>
                </div>
        ):null}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {settings.map((setting) => (
                <a href={setting.href} class="block p-6 border border-gray-200 rounded-lg hover:border-blue-400 hover:shadow-md transition-all">
                    <h2 class="text-xl font-semibold text-gray-900 mb-2">{setting.title}</h2>
                    <div class="mt-4 text-blue-600 text-sm font-medium">Accéder</div>
                </a>
            ))}
        </div>
    </main>
    </body>
</html>